# Proxy traffic from nginx going to the location "django daphne webserver
upstream upstream {
    # Specify where incoming traffic should be directed to.
    # The webserver is running as a docker compose service called "web".
    # This service is listening on port "8080". 
    server web:8080;
}

include       mime.types;
default_type  application/octet-stream; 

server {

 
    listen 80;
    server_name 127.0.0.1;
 

    #-----------------------------------------------------------------------#
    #                         Enable ModSecurity WAF                        #
    #-----------------------------------------------------------------------#
	modsecurity on;
    modsecurity_rules_file modsecurity.conf;

    #-----------------------------------------------------------------------#
    #                   Enable nginx security features                      #
    #-----------------------------------------------------------------------#
    # Do not show the nginx version number in headers.
    server_tokens off;

    # Use Strict Transport Security (HSTS) to declare that clients 
    # should access resources using a secure connection (HTTPS).
    # The browser will refuse all HTTP connections and prevent users
    # from accepting insecure SSL certificates.
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header Content-Security-Policy "upgrade-insecure-requests" always;

    # Stop pages from loading if cross-site scripting is detected
    add_header X-XSS-Protection          "1; mode=block" always;

    # add_header X-Content-Type-Options nosniff;
    # Add a X-Frame-Options HTTP response header to indicate that a browser 
    # should not be allowed to render a page in a <frame> or an <iframe>.
    # This can prevent "clickjacking" attacks. 
    add_header X-Frame-Options           "SAMEORIGIN" always; 

    #-----------------------------------------------------------------------#
    #                   Enable the compression of responses                 #
    #-----------------------------------------------------------------------#
    gzip on;
    gzip_vary on;
    gzip_min_length 10240;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml;

    #-----------------------------------------------------------------------#
    #                           Setup URL routing                           #
    #-----------------------------------------------------------------------#

    # Do not log failed attempts to get the file: favicon.ico
    location = /favicon.ico {
         access_log off;
         error_log off;
         log_not_found off;
    }

    # Do not log failed attempts to get the file: robots.txt
    location = /robots.txt {
        log_not_found off;
         error_log off;
        access_log off;
    }

    location / {
        # Proxy all incoming traffic that is going to /api/ to here:
        proxy_pass http://upstream;
		proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
        # HTTP protocol version for proxying.
        # For Websockets and keepalive connections version 1.1 is needed.
        proxy_http_version 1.1;
		proxy_redirect off;
		proxy_buffering off;
		proxy_force_ranges on;

        # Add request headers that should be passed to Django Daphne webserver.
        proxy_set_header  Host              $http_host;
        proxy_set_header  X-Real-IP         $remote_addr;
        proxy_set_header  X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header  X-Forwarded-Host  $server_name;
        proxy_set_header  X-Forwarded-Proto $scheme;
        proxy_set_header  Upgrade           $http_upgrade;
        proxy_set_header  Connection        "upgrade";
        proxy_redirect off;

        #-------------------------------------------------------------------#
        #                       Add CORS response headers                   #
        #-------------------------------------------------------------------#
        # Add headers that should be returned in a response to a client.
        # For preflight (OPTIONS) requests we should add the following headers listed below:
        if ($request_method = "OPTIONS") {
        
            # Do not use this option in production. It should only be used while testing things.
            # This setting alywas sets the requesting origin as an allowed origin.
            add_header Access-Control-Allow-Origin $http_origin always;
        
            add_header Access-Control-Allow-Methods "GET, POST, PATCH, PUT, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "X-uri, Host, Referer, Accept-Encoding, Origin, Content-Type, Accept, Authorization, X-CustomHeader, Keep-Alive, User-Agent, X-Requested-With, If-Modified-Since, Cache-Control" always;
            add_header Access-Control-Allow-Credentials "true" always;

            add_header Access-Control-Max-Age 1728000;
            add_header Content-Type "text/plain charset=UTF-8";
            add_header Content-Length 0;
            return 204;
        }
        # For all other types of requests (GET, POST, PATCH, PUT and DELETE) we add the following headers listed below:
        if ($request_method ~ "(GET|POST|PATCH|PUT|DELETE)") {
        
            # Do not use this option in production. It should only be used while testing things.
            # This setting alywas sets the requesting origin as an allowed origin.
            add_header Access-Control-Allow-Origin $http_origin always;
        
            add_header Access-Control-Allow-Methods "GET, POST, PATCH, PUT, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "X-uri, Host, Referer, Accept-Encoding, Origin, Content-Type, Accept, Authorization, X-CustomHeader, Keep-Alive, User-Agent, X-Requested-With, If-Modified-Since, Cache-Control" always;
            add_header Access-Control-Allow-Credentials "true" always;
        }
    }

    # Redirect server error pages to the static page /50x.html
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   html;
    }
}

